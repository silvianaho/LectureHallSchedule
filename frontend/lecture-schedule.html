<html>
  <head>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/style-resultviewer.css" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="scss/plugin.css" />
    <link rel="stylesheet" href="css/timetable-custom.css" />
    <script
      src="https://code.jquery.com/jquery-3.5.1.js"
      integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>
    <script src="./js/index.js"></script>
    <!-- <script src="js/lecture-schedule.js" type="text/javascript"></script> -->
    <title>JiBaBoom</title>
  </head>
  <body>
    <div class="wrapper">
      <!-- Sidebar -->
      <nav id="sidebar">
        <div class="sidebar-header">
          <h3>JiBaBoom</h3>
          <strong>JBB</strong>
          <h2 class="h2 d-lg-inline-block d-none" id="sidebar-collapse">
            <span class="close-side">&#171;</span>
            <span class="open">&#187;</span>
          </h2>
        </div>

        <ul class="list-unstyled components">
          <p class="font-weight-bold mb-0">DATA VIEW</p>
          <li class="nav-item">
            <a class="nav-link ml-3 py-1" href="./index.html">
              <span>Lectures</span>
              <i class="material-icons">class</i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link ml-3 py-1" href="./advance-dataviewer.html">
              <span>Technicians</span>
              <i class="material-icons">engineering</i>
            </a>
          </li>
        </ul>
        <ul class="list-unstyled components">
          <p class="font-weight-bold mb-0">SCHEDULE</p>
          <li class="nav-item">
            <a class="nav-link ml-3 py-1" href="./lecture-schedule.html">
              <span>Lectures</span>
              <i class="material-icons">class</i>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link ml-3 py-1" href="./technician-surplus.html">
              <span>Technicians</span>
              <i class="material-icons">engineering</i>
            </a>
          </li>
        </ul>
      </nav>
      <!-- content -->
      <div class="px-3 mx-3" id="content">
        <!-- mobile sidebar control -->
        <div class="title-filter mt-4">
          <div class="page-title float-left">
            <h1 id="sidebar-collapse-small-screen">
              <span class="close-side">&#171;</span>
              <span class="open">&#187;</span>
            </h1>
            <h2 class="mb-3 font-weight-normal">LECTURE SCHEDULE</h2>
          </div>
          <!-- filter -->
          <div class="filter pt-3 float-right">
            <h6 class="ml-0 mb-1">Filter</h6>
            <form class="mb-3" id="filter-form">
              <div class="form-row align-items-center">
                <div class="col-lg-auto pb-md-1">
                  <!-- <input
                    type="number"
                    name="facultyId"
                    id="faculty-id"
                    placeholder="Faculty ID"
                    class="form-control form-control-sm"
                  /> -->
                  <select
                    name="facultyId"
                    id="faculty-id"
                    class="form-control custom-select custom-select-sm"
                  >
                    <option value="" selected disabled
                      >Filter by Faculty ID</option
                    >
                  </select>
                </div>
                <div class="col-lg-auto pb-md-1">
                  <select
                    name="semesterId"
                    id="semester-id"
                    class="form-control custom-select custom-select-sm"
                  >
                    <option value="" selected disabled
                      >Filter by Semester ID</option
                    >
                  </select>
                </div>
                <div class="col-lg-auto pb-md-1">
                  <select
                    name="dayOfWeek"
                    id="day-of-week"
                    class="form-control custom-select custom-select-sm"
                  >
                    <option value selected disabled>Filter by Day</option>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                    <option value="7">Sunday</option>
                  </select>
                </div>
                <div class="col-lg-auto pb-md-1">
                  <button
                    type="submit"
                    id="timetable-submit-button"
                    class="btn btn-primary btn-sm w-100"
                  >
                    Submit
                  </button>
                </div>
                <div class="col-lg-auto pb-md-1">
                  <button id="clear-button" class="btn btn-danger btn-sm w-100">
                    Clear
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <br>
        <div class="showing-info m-0 my-3 float-left">
          <p class="m-0">Showing schedule for - facultyId: <span class="faculty"></span> - semesterId: <span class="semester"></span> - day: <span class="dayofweek"></span></p>
        </div>
        <!-- Timetable -->
        <div class="timetable"></div>
        <div class="not-found text-center d-none">
          <p class="display-4">There is no data with the entered value ;w;</p>
          <p class="display-4">Please try again.</p>
        </div>
      </div>
    </div>
  </body>

  <script src="./js/timetable.js"></script>
  <script>
    const basicResultUrl = host + "/basic/result";

    const resultQuery = {
      facultyId: null,
      semesterId: null,
      dayOfWeek: 0,
    };

    function setShowInfo (resultQuery) {
      const advanceShowFaculty = $(".faculty");
      const advanceShowSemester = $(".semester");
      const advanceShowDay = $(".dayofweek");
      
      advanceShowFaculty.text(resultQuery.facultyId);
      advanceShowSemester.text(resultQuery.semesterId);
      advanceShowDay.text(resultQuery.dayOfWeek);

      $("#faculty-id").val(resultQuery.facultyId);
      $("#semester-id").val(resultQuery.semesterId);
      $("#day-of-week").val(resultQuery.dayOfWeek);

    }

    function getResult(resultQuery, callback) {
      const settings = {
        url: basicResultUrl,
        method: "GET",
        timeout: 0,
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        data: resultQuery,
      };

      $.ajax(settings)
        .done((response) => {
          // console.log(response);
          $(".not-found").addClass("d-none");
          callback(response);
        })
        .fail((response) => {
          $(".timetable").empty();
          $(".not-found").html(
            `<p class='display-4'>Getting lecture schedule failed.</p><p class='display-4'>Please check your input or refresh the page.</p>`
          );
          $(".not-found").removeClass("d-none");
        });
    }

    /* 
    calculate scope for timetable
    @input: lectures data (json)
    @output: {start: int, end: int} (json)
    */
    function convertTime(time) {
      let firstDigit = String(time).substr(0,1)
      let newtime = String(time)
      if (firstDigit != 1) {
        newtime = "0" + newtime;
      }
      return newtime.substr(0,2) + ":" + newtime.substr(2,2) + ":00";
    }

    function calculateScope(data) {
      let earliestTime = parseInt(convertTime(data[0][0].startTime).split(":")[0]);
      var latestTime = 0;

      for (let i = 0; i < data.length; i++) {
        data[i].forEach((lecture) => {
          let end = parseInt(convertTime(lecture.endTime).split(":")[0]) + 1;
          if (end > latestTime) latestTime = end;
        });
      }
      if (latestTime - earliestTime < 13) {
        if (earliestTime + 13 <= 23) {
          return { start: earliestTime, end: earliestTime + 13 };
        } else {
          return { start: earliestTime, end: earliestTime + 13 - 23 };
        }
      }
      return { start: earliestTime, end: latestTime };
    }

    function loadTable(data) {
      let scope = calculateScope(data);
      // console.log(scope);
      var timetable = new Timetable();
      timetable.setScope(scope.start, scope.end); // optional, only whole hours between 0 and 23
      // timetable.useTwelveHour(); //optional, displays hours in 12 hour format (1:00PM)
      let halls = [];
      let lectureList = [];
      for (let i = 0; i < data.length; i++) {
        halls.push("Hall " + (i + 1));
        timetable.addLocations([halls[i]]);
        data[i].forEach((lecture) => {
          timetable.addEvent(
            lecture.lectureId,
            halls[i],
            new Date("2020/01/01 " + convertTime(lecture.startTime)),
            new Date("2020/01/01 " + convertTime(lecture.endTime)),
            {
              class: 'lecture'
            }
          );
        });
      }
      var renderer = new Timetable.Renderer(timetable);
      renderer.draw(".timetable"); // any css selector
    }

    function getInitialData () {
      $.get(pageInfoUrl)
        .done((result) => {
          resultQuery.facultyId = result.facultyid[0].facultyid;
          resultQuery.semesterId = result.semesterid[0].semesterid;
          resultQuery.dayOfWeek = 1;

          getResult(resultQuery, loadTable);
          setShowInfo(resultQuery);

        });
    }

    $("#timetable-submit-button").on("click", (event) => {
      event.preventDefault();
      resultQuery.facultyId = $("#faculty-id").val();
      resultQuery.semesterId = $("#semester-id").val();
      resultQuery.dayOfWeek = $("#day-of-week").val();

      getResult(resultQuery, loadTable);
    });

    $(document).ready(() => {
      getInitialData();
      // setTimeout(() => loadTable(), 500);
    });
  </script>
</html>
